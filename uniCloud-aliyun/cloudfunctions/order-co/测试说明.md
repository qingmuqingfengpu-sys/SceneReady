# order-co 云对象测试说明

> 更新时间：2025-12-18 20:30

---

## Token验证已修复 (2025-12-18)

之前存在的"请先登录"问题已修复。现在使用 `uni-id-common` 模块正确验证 token。

**修复后的验证方法**:
```javascript
// 在小程序中登录后执行
const orderCo = uniCloud.importObject('order-co')
const result = await orderCo.testToken()
// 应返回: { code: 0, data: { uid: 'xxx', hasToken: true } }
```

---

## 问题说明

如果遇到 "Method name is required" 错误,说明在云端运行时没有正确配置方法名。

## 解决方案

### 方法一: 使用 HBuilderX 云端运行

1. **确保配置文件存在**:
   - 文件: `order-co.param.json`
   - 位置: 与 `index.obj.js` 同级目录

2. **配置文件格式**:
```json
{
  "$clientInfo": {
    "methodName": "testToken",
    "uniIdToken": ""
  }
}
```

3. **上传并运行**:
   - 右键点击 `order-co` 文件夹
   - 选择"上传并运行-云端运行"
   - 或者使用快捷键重新上传

### 方法二: 测试其他方法

如果要测试其他方法,修改配置文件:

#### 测试 testToken (不需要登录)
```json
{
  "$clientInfo": {
    "methodName": "testToken"
  }
}
```

#### 测试 getMyOrders (需要登录)
```json
{
  "$clientInfo": {
    "methodName": "getMyOrders",
    "uniIdToken": "你的token"
  },
  "page": 1,
  "pageSize": 10
}
```

#### 测试 add (需要登录)
```json
{
  "$clientInfo": {
    "methodName": "add",
    "uniIdToken": "你的token"
  },
  "data": {
    "people_needed": 1,
    "meeting_location_name": "测试地点",
    "meeting_location": {
      "type": "Point",
      "coordinates": [116.397128, 39.916527]
    },
    "meeting_time": 1734000000000,
    "price_type": "daily",
    "price_amount": 10000
  }
}
```

## 获取 Token

如果需要测试需要登录的方法,先从小程序获取 token:

1. 在小程序中登录
2. 在控制台运行:
```javascript
console.log(uni.getStorageSync('uni_id_token'))
```
3. 复制 token 到配置文件的 `uniIdToken` 字段

## 注意事项

1. **配置文件必须与云对象文件在同一目录**
2. **配置文件名必须是 `云对象名.param.json`**
3. **每次修改配置后需要重新上传**
4. **testToken 方法可以不需要 token,适合快速测试**

## 推荐测试流程

1. 先测试 `testToken` 方法,确保云对象可以正常运行
2. 如果 testToken 成功,说明云对象本身没问题
3. 再测试需要登录的方法,如 `getMyOrders`

## 常见错误

### "Method name is required"
- 原因: 配置文件中没有 methodName 字段
- 解决: 检查配置文件格式

### "请先登录" (已修复 2025-12-18)
- 原因: ~~调用需要登录的方法时没有提供 token~~ 云函数未正确验证 token
- 解决:
  1. 确认已重新上传包含 `uni-id-common` 依赖的 `order-co`
  2. 在配置文件中添加 uniIdToken
  3. 或在小程序中登录后调用

### "Token已过期"
- 原因: token 过期
- 解决: 重新从小程序获取新的 token
