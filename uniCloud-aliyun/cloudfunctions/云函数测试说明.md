# 云函数测试说明

> 更新时间：2025-12-18 20:30

---

## 0. Token验证修复说明 (2025-12-18)

### 问题已修复
之前 `order-co` 云对象存在 token 验证问题，用户已登录但调用接口提示"请先登录"。

### 修复内容
- `order-co/package.json` 添加 `uni-id-common` 依赖
- `order-co/index.obj.js` 使用 `uniIdCommon.checkToken()` 正确验证 token

### 部署后测试
```bash
1. 右键 order-co -> "上传部署"
2. 在小程序中登录
3. 调用 order-co.testToken() 验证
4. 返回 uid 则表示修复成功
```

---

## 1. geo-service 云函数测试

### 测试配置文件
文件位置: `geo-service/geo-service.param.json`

### 测试方法
在 HBuilderX 中右键点击 `geo-service` 文件夹,选择"上传并运行",系统会自动使用 `geo-service.param.json` 中的参数。

### 可用的测试参数

#### 1. 逆地理编码 (坐标转地址)
```json
{
  "action": "regeo",
  "longitude": 116.397470,
  "latitude": 39.908823
}
```
说明: 将北京天安门的坐标转换为地址

#### 2. 地理编码 (地址转坐标)
```json
{
  "action": "geo",
  "address": "北京市朝阳区",
  "city": "北京"
}
```
说明: 将地址转换为坐标

#### 3. 地址搜索
```json
{
  "action": "search",
  "keywords": "咖啡厅",
  "city": "北京"
}
```
说明: 搜索北京的咖啡厅

---

## 2. order-co 云对象测试

### 测试配置文件
文件位置: `order-co/order-co.param.json`

### 测试方法
在 HBuilderX 中右键点击 `order-co` 文件夹,选择"上传并运行",系统会自动使用 `order-co.param.json` 中的参数。

### 当前默认测试方法
```json
{
  "$clientInfo": {
    "methodName": "testToken"
  }
}
```
说明: 测试云对象的 token 获取功能,此方法不需要登录即可测试

### 可用的测试方法

#### 1. testToken - 测试token (不需要登录)
```json
{
  "$clientInfo": {
    "methodName": "testToken"
  }
}
```

#### 2. getMyOrders - 获取我的订单列表 (需要登录)
```json
{
  "$clientInfo": {
    "methodName": "getMyOrders"
  },
  "page": 1,
  "pageSize": 10
}
```

#### 3. add - 发布订单 (需要登录且为剧组角色)
```json
{
  "$clientInfo": {
    "methodName": "add"
  },
  "people_needed": 2,
  "role_description": "群众演员",
  "meeting_location_name": "朝阳公园",
  "meeting_location": {
    "type": "Point",
    "coordinates": [116.397470, 39.908823]
  },
  "meeting_time": 1733875200000,
  "gender_requirement": 0,
  "height_min": 0,
  "height_max": 0,
  "body_type": [],
  "special_skills": [],
  "welfare_tags": ["meal"],
  "price_type": "daily",
  "price_amount": 30000,
  "remark": "测试订单"
}
```
注意: `meeting_time` 需要设置为未来的时间戳

---

## 注意事项

### 1. 云对象 vs 云函数的区别

- **云函数** (`geo-service`): 使用 `uniCloud.callFunction()` 调用,参数在 `data` 中
- **云对象** (`order-co`): 使用 `uniCloud.importObject()` 调用,直接调用方法

### 2. 登录问题 (已修复 2025-12-18)

`order-co` 云对象的大部分方法需要登录。

**如果您看到"请先登录"错误**:

1. 确认已重新上传 `order-co` 云对象（包含 uni-id-common 依赖）
2. 使用 `testToken` 方法测试 token 验证是否正常
3. 在前端页面登录后，`testToken` 应返回正确的 `uid`

**测试方法**:
```javascript
// 在小程序中执行
const orderCo = uniCloud.importObject('order-co')
const result = await orderCo.testToken()
console.log(result)
// 成功: { code: 0, data: { uid: 'xxx', hasToken: true } }
```

### 3. 修改测试参数

如果需要测试不同的场景:
1. 编辑对应的 `.param.json` 文件
2. 修改参数值
3. 保存后重新"上传并运行"

### 4. 快速切换测试方法

对于 `order-co`,如果想测试不同方法,只需修改 `order-co.param.json` 中的 `methodName` 和参数即可。

---

## 预期的成功结果

### geo-service 成功返回示例
```json
{
  "code": 0,
  "data": {
    "name": "天安门广场",
    "address": "北京市东城区天安门广场",
    "province": "北京市",
    "city": "北京市",
    "district": "东城区",
    ...
  }
}
```

### order-co.testToken 成功返回示例
```json
{
  "code": 0,
  "message": "测试成功",
  "data": {
    "hasToken": false,
    "token": null,
    "cloudInfo": {...},
    "timestamp": 1733875200000
  }
}
```

如果 `hasToken` 为 `false`,说明当前没有登录,这是正常的。
