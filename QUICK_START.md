# 艺拍即合 - 快速启动指南

> 更新时间：2025-12-18 20:30

## 🎉 恭喜!所有发单功能已配置完成

---

## 🔧 最近修复 (2025-12-18)

### Token验证问题已修复

**问题**: 用户已登录但调用云对象提示"请先登录"

**原因**: `this.getUniIdToken()` 返回的是 token 字符串，不是包含 uid 的对象

**修复方案**: 使用 `uni-id-common` 模块正确验证 token

**部署步骤** (必须执行):
```bash
1. 右键 order-co -> "上传部署"
2. 右键 user-co -> "上传部署"
3. 右键 database -> "上传 DB Schema"
4. 重新编译运行小程序
```

详细说明请参考: `uniCloud-aliyun/cloudfunctions/order-co/README_TOKEN_ISSUE.md`

---

## ✅ 已完成的配置清单

### 1. 核心配置文件
- ✅ **pages.json** - 已添加剧组端页面路由
- ✅ **manifest.json** - 已配置高德地图API Key (976d8beb7728d3ee2b3ef1c8a1b3611a)
- ✅ **微信小程序权限** - 已配置位置权限和隐私声明

### 2. 数据库设计
- ✅ **uni-id-users** 扩展 (角色、信用分、认证信息)
- ✅ **orders** 订单表 (福利标签、订单类型、定价)
- ✅ **order_tracks** 轨迹表 (LBS追踪)
- ✅ **索引优化** (地理空间索引、信用分索引)

### 3. 前端页面
- ✅ **pages/index/index.vue** - 应用首页(角色选择入口)
- ✅ **pages/crew/index.vue** - 剧组端首页
- ✅ **pages/crew/post_order.vue** - 发布需求页面
- ✅ **pages/crew/order_list.vue** - 订单列表页面

### 4. 云端服务
- ✅ **order-co** 云对象 - 订单增删改查
- ✅ **geo-service** 云函数 - 地理编码服务

---

## 🚀 立即开始使用

### 步骤1: 上传云函数(必须!)

#### 在 HBuilderX 中操作:

**上传 order-co 云对象:**
```
1. 右键点击 uniCloud-aliyun/cloudfunctions/order-co
2. 选择 "上传部署" → "上传云端安装依赖并运行"
3. 等待上传成功提示
```

**上传 geo-service 云函数:**
```
1. 右键点击 uniCloud-aliyun/cloudfunctions/geo-service
2. 选择 "上传部署" → "上传云端安装依赖并运行"
3. 等待上传成功提示
```

### 步骤2: 初始化数据库

**上传 Schema 文件:**
```
1. 右键点击 uniCloud-aliyun/database/orders.schema.json
2. 选择 "上传Schema及扩展校验函数"
3. 重复以上步骤上传:
   - uni-id-users.schema.json
   - order_tracks.schema.json
```

**创建索引:**
```
方法1: 使用自动创建(推荐)
- Schema文件已包含索引定义
- 上传Schema后会自动创建

方法2: 手动创建
- 参考 uniCloud-aliyun/database/*.index.json 文件
- 在Web控制台手动创建索引
```

### 步骤3: 运行项目

```bash
# 小程序端
1. 在HBuilderX中点击 "运行" → "运行到小程序模拟器" → "微信开发者工具"
2. 在首页点击 "剧组端" 卡片
3. 进入剧组首页,点击 "发布需求"

# H5端
1. 点击 "运行" → "运行到浏览器" → "Chrome"
2. 同样操作测试
```

---

## 📱 功能演示流程

### 完整发单流程:

```
1. 打开应用 → 点击 "剧组端" 卡片
   ↓
2. 剧组首页 → 点击 "发布需求" 按钮
   ↓
3. 填写表单:
   ├─ 基本信息: 需要人数、角色描述
   ├─ 集合信息: 点击选择地点、选择时间
   ├─ 演员要求: 性别、身高、体型、特长
   ├─ 福利待遇: 勾选 [包盒饭] [报销路费] 等
   └─ 定价设置: 选择"按天",输入金额
   ↓
4. 系统自动判断订单类型:
   ├─ 即时单(<2h): "接单后立即开启实时定位追踪"
   └─ 预约单(>2h): "演员出发后开启定位,保护隐私省电"
   ↓
5. 点击 "发布需求" → 成功提示
   ↓
6. 跳转到订单列表,查看刚发布的订单
```

---

## 🎯 测试要点

### 测试1: 即时单发布
```javascript
集合时间: 当前时间 + 1小时
预期结果:
- 底部提示: "即时单:接单后立即开启实时定位追踪"
- 订单详情: order_type = 'immediate'
```

### 测试2: 预约单发布
```javascript
集合时间: 当前时间 + 3小时
预期结果:
- 底部提示: "预约单:演员出发后开启定位,保护隐私省电"
- 订单详情: order_type = 'reservation'
```

### 测试3: 地图选点
```
1. 点击 "集合地点" 输入框
2. 在地图上选择位置
3. 确认地址显示正确
4. 验证坐标正确存储(GeoPoint格式)
```

### 测试4: 福利标签
```
1. 勾选多个福利标签
2. 发布后查看订单详情
3. 确认标签正确保存为数组
```

---

## 🔧 配置高德地图Key(已完成)

当前使用的Key: **976d8beb7728d3ee2b3ef1c8a1b3611a**

### 配置位置:
```json
// manifest.json
"app-plus": {
  "sdkConfigs": {
    "maps": {
      "amap": {
        "appkey_ios": "976d8beb7728d3ee2b3ef1c8a1b3611a",
        "appkey_android": "976d8beb7728d3ee2b3ef1c8a1b3611a"
      }
    }
  }
}

// geo-service/index.js
const AMAP_KEY = '976d8beb7728d3ee2b3ef1c8a1b3611a'
```

---

## 📊 数据流程图

```
┌─────────────┐
│  应用首页    │ 点击"剧组端"
└──────┬──────┘
       ↓
┌─────────────┐
│  剧组首页    │ 统计数据、快捷操作、最近订单
└──────┬──────┘
       ↓ 点击"发布需求"
┌─────────────┐
│  发单页面    │
├─────────────┤
│ ① 填写表单   │ → uni-forms验证
│ ② 选择地点   │ → uni.chooseLocation + geo-service
│ ③ 选择时间   │ → uni-datetime-picker
│ ④ 福利标签   │ → uni-data-checkbox
│ ⑤ 定价设置   │ → 按天/按时 + 金额
└──────┬──────┘
       ↓ 提交
┌─────────────┐
│   云对象     │ order-co.add()
├─────────────┤
│ ① 权限校验   │ → user_role=1, auth_status=2
│ ② 数据验证   │ → 必填项、合法性
│ ③ 类型判断   │ → immediate / reservation
│ ④ 存入数据库 │ → orders表
│ ⑤ 推送通知   │ → 附近演员(仅即时单)
└──────┬──────┘
       ↓
┌─────────────┐
│  订单列表    │ 查看、取消、详情
└─────────────┘
```

---

## 🎨 UI效果预览

### 应用首页
```
━━━━━━━━━━━━━━━━━━━━━━
    艺拍即合
  短剧行业用工平台
━━━━━━━━━━━━━━━━━━━━━━
┌──────────┬──────────┐
│  💼      │  ⭐      │
│ 剧组端    │ 演员端    │
│发布需求   │抢单接单   │
└──────────┴──────────┘
  [个人资料] [登录/注册]
━━━━━━━━━━━━━━━━━━━━━━
```

### 剧组首页
```
━━━━━━━━━━━━━━━━━━━━━━
统计卡片:
  [5] 待接单  [2] 进行中  [10] 已完成
━━━━━━━━━━━━━━━━━━━━━━
快捷操作:
  [➕ 发布需求]  [📋 我的订单]
━━━━━━━━━━━━━━━━━━━━━━
最近订单:
  ┌────────────────┐
  │ 待接单  1小时前 │
  │ 📍 重庆大学     │
  │ 📅 12-08 14:00 │
  │ 👤 需要2人      │
  │ ¥100 按天       │
  │ #包盒饭 #报路费 │
  └────────────────┘
━━━━━━━━━━━━━━━━━━━━━━
```

### 发单页面
```
━━━━━━━━━━━━━━━━━━━━━━
基本信息
  需要人数: [1]
  角色描述: [群众演员...]
━━━━━━━━━━━━━━━━━━━━━━
集合信息
  集合地点: [点击选择] 📍
  集合时间: [2024-12-08 14:00]
━━━━━━━━━━━━━━━━━━━━━━
演员要求
  性别: ○不限 ○男 ○女
  身高: [170] - [180] cm
  体型: #标准 #健壮
━━━━━━━━━━━━━━━━━━━━━━
福利待遇
  #包盒饭 #报销路费 #提供住宿
━━━━━━━━━━━━━━━━━━━━━━
定价设置
  计费: ○按天 ○按时
  金额: [100] 元
━━━━━━━━━━━━━━━━━━━━━━
💡 预约单:演员出发后开启定位
     [  发布需求  ]
━━━━━━━━━━━━━━━━━━━━━━
```

---

## 🐛 常见问题

### Q0: 已登录但提示"请先登录"? ⭐新修复

**症状**: 用户已经登录，但调用云对象时返回"请先登录"

**原因**: 云函数未正确验证 token

**解决方法**:
```
1. 确认 order-co/package.json 包含 uni-id-common 依赖
2. 重新上传 order-co 云对象
3. 重新上传 user-co 云对象
4. 上传 database schema
5. 重新编译小程序
```

### Q1: 云函数调用失败?
```
解决方法:
1. 确认已上传云函数
2. 在uniCloud Web控制台查看云函数日志
3. 检查用户是否已登录
```

### Q2: 地图选点无法使用?
```
解决方法:
1. 小程序端: 微信公众平台配置合法域名
2. App端: 检查高德Key是否正确
3. 确认已授权位置权限
```

### Q3: 订单创建失败?
```
检查项:
1. 用户是否为剧组角色(user_role=1)
2. 是否已完成企业认证(auth_status=2)
3. 查看云函数日志排查具体错误
```

---

## 📚 相关文档

- **完整部署指南**: `DEPLOYMENT_GUIDE.md`
- **数据库索引说明**: `uniCloud-aliyun/database/DATABASE_INDEX_README.md`
- **发单功能文档**: `pages/crew/POST_ORDER_README.md`
- **需求文档**: `readme.md`

---

## 🎯 下一步开发

### 优先级1: 演员端开发
- [ ] 任务大厅(LBS地图展示)
- [ ] 抢单功能
- [ ] 轨迹追踪

### 优先级2: 完善功能
- [ ] 推送通知
- [ ] 学生/企业认证审核
- [ ] 支付结算

### 优先级3: 数据统计
- [ ] 管理后台
- [ ] 数据看板
- [ ] 信用分算法优化

---

## ✨ 核心亮点

### 1. 自动订单类型判断
```javascript
const diffHours = (meetingTime - now) / (1000 * 60 * 60)
order_type = diffHours < 2 ? 'immediate' : 'reservation'
```

### 2. 福利标签优先推送
```javascript
// 高福利订单 → 高信用演员
welfare_tags: ['meal', 'taxi', 'accommodation']
credit_score_actor >= 120
```

### 3. 地理编码服务
```javascript
// 坐标 → 地址
geo-service.regeo(longitude, latitude)
→ "重庆市沙坪坝区大学城西路999号"
```

### 4. 双向信用体系
```javascript
// 演员信用分 + 剧组信用分
credit_score_actor: 100-150
credit_score_crew: 100-150
```

---

**所有功能已就绪,开始您的发单之旅吧!** 🚀
